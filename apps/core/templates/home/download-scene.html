{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'styles/style.css' %}">
    <link rel="stylesheet" href="{% static 'styles/music.css' %}">
    <link rel="stylesheet" href="{% static 'styles/fonts.css' %}">
    <link rel="stylesheet" href="{% static 'styles/main.css' %}">
    <link rel="stylesheet" href="{% static 'styles/download-scene.css' %}">
    <link rel="icon" href="{% static 'images/iconlogo.svg' %}">
    <!-- Force HTTPS for all resources to prevent mixed content warnings -->
    <title>VideoCrafter.io</title>
</head>

<body>
    <header class="header">
        <div class="main-div">
            <div class="sub-main-div">
                <img src="{% static 'images/logo.svg' %}" alt="Logo">
                <a href="{% url 'preview' %}" class="anchor-sub-main"></a>
            </div>
            <div class="right">
                <span class="right-span">Credits Remaining: <span id="number">{{ user_subscription.unused_credits }}</span>
                </span>
                <div class="line"></div>
                <div class="img" id="pfp" onclick="toggleDropdown()">
                    <div class="img-sub-div">
                        <div class="img-sub">
                            <img src="{% static 'images/profile.svg' %}" alt="Profile">
                        </div>
                    </div>
                </div>

                <div id="pfpdropdown" class="not-present">
                    <div class="not-present-sub">
                        <span class="not-present-sub-span1">{{ user_subscription.user.first_name }}</span>
                        <span class="not-present-sub-span2">{{ user_subscription.user.email }}</span>
                    </div>
                    <div class="profile-main-div">
                        <div class="profile-sub-div">
                            <div class="dropdownText">
                                <span class="dropdownText" style="width: fit-content;">Credit Left</span>
                                <span class="dropdownText" style="width: fit-content; color: #19191980;">{{ user_subscription.unused_credits }}</span>
                            </div>
                        </div>
                        <span class="dropdownText">
                            <a href="{% url 'asset_library' %}">Manage Asset Library</a>

                        </span>
                        <span class="dropdownText">
                            <a href="{% url 'recent_videos' %}">Manage Video Drafts</a>
                        </span>
                        <span class="dropdownText">
                            <a href="{% url 'manage_subscription' %}">Manage Subscription</a>
                        </span>
                    </div>
                    <div class="profile-last-div">
                        <span class="dropdownText"><a href="{% url 'logout' %}">Log Out</a></span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="progressbar">
        <div class="sub-div">
            <div class="progress-fill" style="width:66.66666666666667%"></div>
            <div class="sub-div2 completed"></div>
            <div class="sub-div3 completed"></div>
            <div class="sub-div4 active"></div>
            <div class="sub-div5 "></div>
            <div class="voice-subtitle ">Voice & Subtitle Design</div>
            <div class="sceneselection ">Scene Selection</div>
            <div class="bgmselection active-text">Background Music Selection</div>
            <div class="download ">Download</div>
        </div>
    </div>
    <div class="down-container">
        <div class="down-sub-container">
            <a href="{% url 'background_music' video.id %}" class="go-to-change">
                <span style="line-height: 24px;">Go Back To Change Background Music</span>
            </a>
            <div>
                <span class="successfully-text">Your Video Has Been Generated Successfully</span>
            </div>
            <div id="video-container-box">
                <div id="videoPreviewContainer">
                    <video id="download-video" class="video-js vjs-default-skin vjs-big-play-centered" controls
                        preload="auto" controlsList="nodownload" oncontextmenu="return false;">
                        <source src="{{ video_url_preview }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
            <a href="/manage/recent-videos.html" class="draft">
                <span class="draft-heading">Save as Draft</span>
            </a>
            {% if 'free' in user_subscription.plan.name|lower %}
                <a id="downloadButton" class="download-link disabled" style="pointer-events: none;background-color: #19191980;">
                    <span id="download_text">Upgrade to Download</span>
                </a>
            {% else %}
                <a id="downloadButton" href="{% url 'proxy_video_download' video.id %}?redirect_to=preview" class="download-link" download>
                    <img src="{% static 'images/download-icon.svg' %}" alt="Download Icon">
                    <span id="download_text">Download</span>
                </a>
                <p class="watermark">
                    *Please Note That When You Click Download, Watermark Will Be Removed
                </p>
            {% endif %}
        </div>
    </div>
    </div>
    <script src="{% static 'js/header-toggle.js' %}"></script>
    <script src="{% static 'js/progress.js' %}"></script>
    
    <!-- Script to handle post-download redirect -->
    <script>
        // Function to get cookie value by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // Check for redirect cookie on page load
        document.addEventListener('DOMContentLoaded', function() {
            const redirectTo = getCookie('post_download_redirect');
            if (redirectTo) {
                // Clear the cookie
                document.cookie = "post_download_redirect=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                
                // Redirect to the specified page
                if (redirectTo === 'preview') {
                    window.location.href = "{% url 'preview' %}";
                }
            }
            
            // Add event listener to download button to handle redirect after download starts
            const downloadButton = document.getElementById('downloadButton');
            if (downloadButton) {
                downloadButton.addEventListener('click', function() {
                    // Set a timeout to check for redirect cookie periodically after download starts
                    setTimeout(function checkForRedirect() {
                        const redirectTo = getCookie('post_download_redirect');
                        if (redirectTo) {
                            // Clear the cookie
                            document.cookie = "post_download_redirect=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                            
                            // Redirect to the specified page
                            if (redirectTo === 'preview') {
                                window.location.href = "{% url 'preview' %}";
                            }
                        } else {
                            // Keep checking for the cookie every second
                            setTimeout(checkForRedirect, 1000);
                        }
                    }, 2000); // Start checking after 2 seconds
                });
            }
        });
    </script>
</body>

</html>