<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles/manage-asset-library.css' %}">
    <link rel="stylesheet" href="{% static 'styles/style.css' %}">
    <link rel="stylesheet" href="{% static 'styles/main.css' %}">
    <link rel="icon" href="{% static 'images/iconlogo.svg' %}">
    <title>VideoCrafter.io</title>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .folder-icon {
            color: #ffc107;
            margin-right: 5px;
        }
        .file-icon {
            color: #6c757d;
            margin-right: 5px;
        }
        .toggle-icon {
            cursor: pointer;
            margin-right: 5px;
            display: inline-block;
            font-weight: bold;
        }
        .toggle-icon.expanded {
            transform: rotate(90deg);
        }
        .log-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }
        .log-item > div:first-child {
            flex: 2;
            display: flex;
            align-items: center;
        }
        .log-item > div:nth-child(2),
        .log-item > div:nth-child(3) {
            flex: 1;
        }
        .child-item {
            background-color: rgba(0, 0, 0, 0.02);
            padding-left: 40px !important;
            display: none !important; /* Force hide by default with !important */
        }
        /* Only when explicitly shown */
        .child-item.visible {
            display: flex !important;
        }

        /* Upgrade overlay styles */
        .upgrade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .upgrade-container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .upgrade-container h2 {
            margin-top: 0;
            color: #333;
            font-size: 24px;
        }
        
        .upgrade-container p {
            margin: 20px 0;
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .upgrade-button {
            display: inline-block;
            background-color: #9662f9;
            color: white;
            padding: 12px 25px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .upgrade-button:hover {
            background-color: #8450e7;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="main-div">
            <div class="sub-main-div">
                <img src="{% static 'images/logo.svg' %}" alt="Logo">
                <a href="{% url 'preview' %}" class="anchor-sub-main"></a>
            </div>
            <div class="right">
                <span class="right-span">Credits Remaining: <span id="number">{{ user_subscription.unused_credits }}</span>
            </span>
                <div class="line"></div>
                <div class="img" id="pfp" onclick="toggleDropdown()">
                    <div class="img-sub-div">
                        <div class="img-sub">
                            <img src="{% static 'images/profile.svg' %}" alt="Profile">
                        </div>
                    </div>
                </div>

                <div id="pfpdropdown" class="not-present">
                    <div class="not-present-sub">
                        <span class="not-present-sub-span1">{{ user_subscription.user.first_name}}</span>
                        <span class="not-present-sub-span2">{{ user_subscription.user.email }}</span>
                    </div>
                    <div class="profile-main-div">
                        <div class="profile-sub-div">
                            <div class="dropdownText">
                                <span class="dropdownText" style="width: fit-content;">Credit Left</span>
                                <span class="dropdownText" style="width: fit-content; color: #19191980;">{{ user_subscription.unused_credits }}</span>
                            </div>
                        </div>
                        <span class="dropdownText">
                            <a href="{% url 'asset_library' %}">Manage Asset Library</a>
                        </span>
                        <span class="dropdownText">
                            <a href="{% url 'recent_videos' %}">Manage Video Drafts</a>
                        </span>
                        <span class="dropdownText">
                            <a href="{% url 'manage_subscription' %}">Manage Subscription</a>
                        </span>
                        <span class="dropdownText">
                            <a href="{% url 'speed_up_video' %}">Video Speed Up</a>
                        </span>
                    </div>
                    <div class="profile-last-div">
                        <span class="dropdownText"><a href="{% url 'logout' %}">Log Out</a></span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div>
        {% if 'free' in user_subscription.plan.name|lower %}
        <!-- Upgrade overlay for free users -->
        <div class="upgrade-overlay">
            <div class="upgrade-container">
                <h2>Premium Feature</h2>
                <p>The Asset Library is available exclusively for premium users. Upgrade your account to organize, manage, and utilize your media files effectively.</p>
                <p>Unlock this feature and many more with our premium plans!</p>
                <a href="{% url 'manage_subscription' %}" class="upgrade-button">Upgrade Now</a>
            </div>
        </div>
        {% endif %}
        
        <div id="loader" style="display: none; position: fixed; z-index: 9999; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #9662f9; border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
        <main>
            <div class="content">
                <div class="box">
                    <div class="boxHeader">
                        <div class="folderpath">
                            <a href="#" class="link-tag">Assets Library</a>
                            <img src="{% static 'images/chewron.svg' %}" alt="Chevron Icon">
                        </div>
                        <div class="newFolder">
                            <a href="#" class="import-folder-link link-tag" onclick="openModal()">
                                <img src="{% static 'images/create.svg' %}" alt="Create Folder Icon">
                                <span style="padding-left: 5px;">Import Folder</span>
                            </a>
                        </div>
                    </div>

                    <div class="log">
                        <div class="log-header">
                            <div><input type="checkbox" name="selectall" id="selectall" style="opacity: 0;">Folder Name</div>
                            <div>Items</div>
                            <div>Modified At</div>
                        </div>
                        
                        <!-- Display folders with their child files -->
                        {% for folder_info in folder_structure %}
                        <!-- Folder row -->
                        <div class="log-item folder-item" data-folder-id="{{ folder_info.folder.id }}">
                            <div>
                                <input type="checkbox" name="selectall" id="selectall-{{ folder_info.folder.id }}" style="opacity: 0;">
                                <span class="toggle-icon" data-folder-id="{{ folder_info.folder.id }}" onclick="toggleFolderContents(event, '{{ folder_info.folder.id }}')">‚ñ∂</span>
                                <a href="#" class="link-tag folder-name" onclick="toggleFolderContents(event, '{{ folder_info.folder.id }}')">
                                    <span class="folder-icon">üìÅ</span>
                                    {{ folder_info.folder.filename }}
                                </a>
                            </div>
                            <div>{{ folder_info.children|length }} items</div>
                            <div>{{ folder_info.folder.created_at|date:"M. d, Y, g:i a" }}</div>
                            <img src="{% static 'images/dots.svg' %}" class="menu" alt="Menu Options" onclick="toggleMenu(event, {{ folder_info.folder.id }})"
                                style="cursor: pointer;">
                            <div class="actions" id="actions-{{ folder_info.folder.id }}"
                                style="display: none; position: absolute; right: 20px; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px; z-index: 100;">
                                <div>
                                    <a href="#" class="rename-folder-link link-tag"
                                        onclick="showRenameForm({{ folder_info.folder.id }}, '{{ folder_info.folder.filename }}', true)">
                                        <img src="{% static 'images/edit-btn.svg' %}" alt="Rename Icon" style="width: 20px;">
                                        Rename
                                    </a>
                                </div>
                                <div>
                                    <a href="#" class="delete-folder-link link-tag" onclick="deleteFolder({{ folder_info.folder.id }})">
                                        <img src="{% static 'images/delete-icn.svg' %}" alt="Delete Icon" style="width: 20px;">
                                        Delete
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Child files -->
                        {% for child in folder_info.children %}
                        <div class="log-item child-item" data-parent-id="{{ folder_info.folder.id }}">
                            <div>
                                <input type="checkbox" name="selectchild" id="selectchild-{{ child.id }}" style="opacity: 0;">
                                <a href="#" class="link-tag file-name">
                                    <span class="file-icon">üìÑ</span>
                                    {{ child.filename }}
                                </a>
                            </div>
                            <div>{{ child.file_size_display }}</div>
                            <div>{{ child.created_at|date:"M. d, Y, g:i a" }}</div>
                            <img src="{% static 'images/dots.svg' %}" class="menu" alt="Menu Options" onclick="toggleMenu(event, {{ child.id }})"
                                style="cursor: pointer;">
                            <div class="actions" id="actions-{{ child.id }}"
                                style="display: none; position: absolute; right: 20px; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px; z-index: 100;">
                                <div>
                                    <a href="#" class="rename-folder-link link-tag"
                                        onclick="showRenameForm({{ child.id }}, '{{ child.filename }}', false)">
                                        <img src="{% static 'images/edit-btn.svg' %}" alt="Rename Icon" style="width: 20px;">
                                        Rename
                                    </a>
                                </div>
                                <div>
                                    <a href="#" class="delete-folder-link link-tag" onclick="deleteFolder({{ child.id }})">
                                        <img src="{% static 'images/delete-icn.svg' %}" alt="Delete Icon" style="width: 20px;">
                                        Delete
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endfor %}
                        
                        <!-- Display root-level files (not in any folder) -->
                        {% for asset in root_assets %}
                        <div class="log-item" data-asset-id="{{ asset.id }}">
                            <div>
                                <input type="checkbox" name="selectfile" id="selectfile-{{ asset.id }}" style="opacity: 0;">
                                <a href="#" class="link-tag file-name">
                                    <span class="file-icon">üìÑ</span>
                                    {{ asset.filename }}
                                </a>
                            </div>
                            <div>{{ asset.file_size_display }}</div>
                            <div>{{ asset.created_at|date:"M. d, Y, g:i a" }}</div>
                            <img src="{% static 'images/dots.svg' %}" class="menu" alt="Menu Options" onclick="toggleMenu(event, {{ asset.id }})"
                                style="cursor: pointer;">
                            <div class="actions" id="actions-{{ asset.id }}"
                                style="display: none; position: absolute; right: 20px; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px; z-index: 100;">
                                <div>
                                    <a href="#" class="rename-folder-link link-tag"
                                        onclick="showRenameForm({{ asset.id }}, '{{ asset.filename }}', false)">
                                        <img src="{% static 'images/edit-btn.svg' %}" alt="Rename Icon" style="width: 20px;">
                                        Rename
                                    </a>
                                </div>
                                <div>
                                    <a href="#" class="delete-folder-link link-tag" onclick="deleteFolder({{ asset.id }})">
                                        <img src="{% static 'images/delete-icn.svg' %}" alt="Delete Icon" style="width: 20px;">
                                        Delete
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Show message if no assets -->
                        {% if not folder_structure and not root_assets %}
                        <div class="log-item" style="text-align: center; color: #6c757d;">
                            <div colspan="3">No assets found. Click "Import Folder" to upload assets.</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>

        <div id="rename-container" style="display: none; position: fixed; z-index: 9999; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); padding: 20px; width: 350px;">
            <h3 style="margin-top: 0;">Rename Asset</h3>
            <form id="direct-rename-form" method="POST" action="">
                {% csrf_token %}
                <input type="hidden" id="rename-asset-id" name="asset_id" value="">
                <input type="hidden" id="rename-is-folder" name="is_folder" value="false">
                <div style="margin-bottom: 15px;">
                    <label for="new_name" style="display: block; margin-bottom: 5px;">New Name:</label>
                    <input type="text" id="rename-new-name" name="new_name" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                    <!-- Warning message about file extensions -->
                    <div id="rename-extension-warning" style="margin-top: 8px; color: #e74c3c; font-size: 12px; display: none;">
                        <strong>Warning:</strong> Please include the file extension (e.g., .mp4, .jpg, .png) when renaming files.
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end;">
                    <button type="button" onclick="hideRenameForm()" style="padding: 8px 15px; margin-right: 10px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button type="submit" id="rename-submit-btn" style="padding: 8px 15px; background: #9662f9; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                </div>
            </form>
            <!-- Loader inside the rename form - initially hidden -->
            <div id="rename-loader" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); border-radius: 8px; justify-content: center; align-items: center; z-index: 10000;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #9662f9; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>

        <div class="modal" id="uploadModal" style="display: none;">
            <div class="modal-content">
                <form id="uploadForm" enctype="multipart/form-data" method="POST" action="{% url 'asset_library' %}">
                    {% csrf_token %}
                    <div class="modal-text">
                        <h2>Upload Folder</h2>
                        <p>Please Make Sure Your Folder Contains Video Clips</p>
                    </div>
                    <input id="fileInput" class="fileUpload" type="file" name="folder" webkitdirectory multiple>
                    <input id="zipFile" type="file" name="zip_file" style="display: none;" accept=".zip">
                    <div>
                        <div class="progressPercent">
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar"
                            style="width: 100%; height: 10px; background: #f0f0f0; border-radius: 5px;">
                            <div class="progress" id="progressBar"
                                style="width: 0%; height: 100%; background: #9662f9; transition: width 0.3s ease;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="upload-btn">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="{% static 'js/asset-lib.js' %}"></script>
    <script src="{% static 'js/header-toggle.js' %}"></script>
    <script>
    // Add loader animation for uploads
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('uploadForm');
        const loader = document.getElementById('loader');
        
        if (uploadForm) {
            uploadForm.addEventListener('submit', function() {
                // loader.style.display = 'block';
            });
        }
        
        // Make sure all child items are hidden initially
        document.querySelectorAll('.child-item').forEach(function(item) {
            item.style.display = 'none';
            item.classList.remove('visible');
        });
        
        // Ensure all toggle icons show the collapsed state
        document.querySelectorAll('.toggle-icon').forEach(function(icon) {
            icon.textContent = '‚ñ∂';
        });
        
        // Close any open menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.matches('.menu') && !e.target.matches('.actions') && !e.target.matches('.actions *')) {
                document.querySelectorAll('.actions').forEach(function(menu) {
                    menu.style.display = 'none';
                });
            }
        });
        
        console.log("DOMContentLoaded event fired! Child items should be hidden.");

        // Handle direct rename form submission
        const directRenameForm = document.getElementById('direct-rename-form');
        const renameLoader = document.getElementById('rename-loader');
        const renameExtensionWarning = document.getElementById('rename-extension-warning');
        const renameNewNameInput = document.getElementById('rename-new-name');

        if (directRenameForm) {
            directRenameForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const assetId = document.getElementById('rename-asset-id').value;
                const newName = renameNewNameInput.value.trim();
                const isFolder = document.getElementById('rename-is-folder').value === 'true';
                
                if (!newName) {
                    alert('Please enter a new name');
                    return;
                }

                // Only check for file extension if it's a file, not a folder
                if (!isFolder && !newName.includes('.')) {
                    renameExtensionWarning.style.display = 'block';
                    return;
                } else {
                    renameExtensionWarning.style.display = 'none';
                }
                
                // Display loading indicator
                renameLoader.style.display = 'flex';
                
                // Update the form action
                this.action = `/rename-asset/${assetId}/`;
                
                // Submit the form directly
                this.submit();
            });

            renameNewNameInput.addEventListener('input', function() {
                const isFolder = document.getElementById('rename-is-folder').value === 'true';
                // Only check file extension for files
                if (!isFolder && this.value.includes('.')) {
                    renameExtensionWarning.style.display = 'none';
                }
            });
        }
    });

    // Show the rename form
    function showRenameForm(id, currentName, isFolder) {
        document.getElementById('rename-asset-id').value = id;
        document.getElementById('rename-new-name').value = currentName;
        document.getElementById('rename-is-folder').value = isFolder ? 'true' : 'false';
        document.getElementById('rename-container').style.display = 'block';
        
        // Only show the extension warning for files, not folders
        const extensionWarning = document.getElementById('rename-extension-warning');
        if (isFolder) {
            extensionWarning.style.display = 'none';
        } else {
            // For files, check if input has extension as typing happens
            const inputField = document.getElementById('rename-new-name');
            // If current name has extension, don't show warning initially
            if (currentName.includes('.')) {
                extensionWarning.style.display = 'none';
            } else {
                // Show warning if file name doesn't have extension
                extensionWarning.style.display = 'block';
            }
            
            // Focus and select the input
            inputField.focus();
            inputField.select();
        }
        
        // Close any open menus
        document.querySelectorAll('.actions').forEach(menu => menu.style.display = 'none');
    }
    
    // Hide the rename form
    function hideRenameForm() {
        document.getElementById('rename-container').style.display = 'none';
    }

    // Toggle folder contents visibility
    function toggleFolderContents(event, folderId) {
        event.preventDefault();
        event.stopPropagation();
        
        console.log("Toggling folder with ID:", folderId);
        
        // Find the folder item
        const folderItem = document.querySelector(`.folder-item[data-folder-id="${folderId}"]`);
        if (!folderItem) {
            console.error("Folder item not found for ID:", folderId);
            return;
        }
        
        // Find the toggle icon
        const toggleIcon = folderItem.querySelector('.toggle-icon');
        if (!toggleIcon) {
            console.error("Toggle icon not found for folder:", folderId);
            return;
        }
        
        // Find the folder icon
        const folderItemIcon = folderItem.querySelector('.folder-icon');
        
        // Find all child items for this folder
        const childItems = document.querySelectorAll(`.child-item[data-parent-id="${folderId}"]`);
        console.log("Found", childItems.length, "child items");
        
        // Determine current state
        const isCurrentlyExpanded = toggleIcon.textContent === '‚ñº';
        
        // Toggle visibility
        if (isCurrentlyExpanded) {
            // Currently expanded, so collapse
            childItems.forEach(function(item) {
                item.style.display = 'none';
                item.classList.remove('visible');
            });
            toggleIcon.textContent = '‚ñ∂';
            if (folderItemIcon) folderItemIcon.textContent = 'üìÅ';
            console.log("Collapsed folder", folderId);
        } else {
            // Currently collapsed, so expand
            childItems.forEach(function(item) {
                item.style.display = 'flex';
                item.classList.add('visible');
            });
            toggleIcon.textContent = '‚ñº';
            if (folderItemIcon) folderItemIcon.textContent = 'üìÇ';
            console.log("Expanded folder", folderId);
        }
    }
    
    // Toggle menu for rename/delete options
    function toggleMenu(event, id) {
        event.preventDefault();
        event.stopPropagation();
        
        // Close all other menus first
        document.querySelectorAll('.actions').forEach(function(menu) {
            if (menu.id !== `actions-${id}`) {
                menu.style.display = 'none';
            }
        });
        
        // Toggle current menu
        const menu = document.getElementById(`actions-${id}`);
        if (menu) {
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
    }
    </script>
</body>
<!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/67bde19ce1b723191240f344/1ikurij78';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to¬†Script-->
</html>